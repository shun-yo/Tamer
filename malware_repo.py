#!/usr/bin/env python3
# -*- coding: utf-8 -*-


import sys
import os
import http.server as server
import socketserver
import os.path

UPLOADED_FILE_DIR = ""

class MyHandler(server.SimpleHTTPRequestHandler):
    def do_GET(self):
        requested_path = self.path
        if requested_path.startswith("/") and len(requested_path) >= 2:
            requested_path = requested_path.split("/")[1]
        if not os.path.isfile(requested_path):
            self.path= "dummy"
        else:
            print("requested:" + self.path)
        return server.SimpleHTTPRequestHandler.do_GET(self)

    def do_PUT(self):
        requested_path = self.path
        print("Post(or put) requested:" + requested_path)
        if requested_path.startswith("/") and len(requested_path) >= 2:
            requested_path = requested_path.split("/")[1]

        response_code = 403

        if requested_path.startswith("log_iotmal_"):
            response_code = 200
            content_len = int(self.headers.get("content-length", 0))
            rawPostData = self.rfile.read(content_len).decode("utf-8")
            out_fname = "%s/%s"%(UPLOADED_FILE_DIR, requested_path)
            f = open(out_fname, "w")
            f.write(rawPostData)
            f.close()
        else:
            response_code = 403


        body = b''
        self.send_response(response_code)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.send_header('Content-length', len(body))
        self.end_headers()
        self.wfile.write(body)


args = sys.argv


PORT = int(args[1])
DIR = args[2]
UPLOADED_FILE_DIR = args[3]
os.chdir(DIR)
Handler = MyHandler
httpd = socketserver.TCPServer(("", PORT), Handler)


print("serving at port" + str(PORT))
httpd.serve_forever()
